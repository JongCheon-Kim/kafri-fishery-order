<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì–´ì´Œ AI ì§€ë„ì±—ë´‡ â€“ í•˜ì´ë¸Œë¦¬ë“œ í”„ë¦¬ì…‹(ì˜¤í”„ë¼ì¸ ë‚´ì¥ + ì„œë²„ ë¶ˆëŸ¬ì˜¤ê¸°)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- no SRI/crossorigin for file:// testing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .fallback { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; font:16px/1.4 system-ui; color:#0f172a }
    .chatbot-container {
      position: fixed; bottom: 20px; right: 20px; width: 400px; height: 600px;
      background:#fff; border:1px solid #cbd5e1; border-radius:12px; display:none; flex-direction:column;
      box-shadow: 0 10px 30px rgba(0,0,0,.15); z-index:1000; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .chatbot-header { background:#2563eb; color:#fff; padding:10px 14px; display:flex; align-items:center; gap:8px; font-weight:700 }
    .chatbot-header .spacer { flex:1 }
    .chatbot-header button { background: transparent; border:0; color:#fff; cursor:pointer }
    .chatbot-body { padding: 10px 10px; display:flex; flex-direction:column; gap:10px; height: calc(100% - 108px) }
    .chatlog { flex:1; border:1px solid #e2e8f0; border-radius: 8px; padding: 8px; overflow:auto; background:#f8fafc }
    .chatlog p { margin: 6px 0; white-space: pre-wrap; }
    .chatbot-footer { display:flex; gap:6px; padding:8px 10px }
    .chatbot-footer input { flex:1; padding:10px 12px; border:1px solid #cbd5e1; border-radius:8px }
    .chatbot-footer button { padding:10px 12px; border:0; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:700 }
    .chatbot-toggle {
      position: fixed; bottom: 20px; right: 20px; z-index: 900;
      background:#2563eb; color:#fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700;
    }
    dialog { border:0; border-radius:14px; width:min(720px,95vw); padding:0; overflow:hidden; }
    dialog::backdrop { background: rgba(0,0,0,.35) }
    .modal-head { background:#2563eb; color:#fff; padding:12px 16px; font-weight:700 }
    .modal-body { padding:12px 16px }
    .modal-foot { display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #e2e8f0 }
    textarea.mono { width:100%; height:260px; font-family: ui-monospace, Consolas, monospace }
    .hint { font-size:12px; color:#475569 }
    .tag { background:#e2e8f0; border-radius:6px; padding:2px 6px; font-size:12px; margin-left:6px }
    .status { position: fixed; left: 12px; bottom: 12px; font:12px/1.4 system-ui; color:#0f172a; background: #ffffffcc; padding:6px 8px; border-radius:8px; border:1px solid #e2e8f0 }

    /* ====== [ADD ONLY] ëª¨ë°”ì¼ ì „ì²´í™”ë©´ + ì…ë ¥ì°½ ì˜ë¦¼ ë°©ì§€ (CSSë§Œ ì¶”ê°€) ====== */
    @media (max-width: 768px) {
      .chatbot-container {
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;

        width: 100vw !important;
        height: 100dvh !important;
        min-height: 100dvh !important;

        border-radius: 0 !important;
        z-index: 99999 !important;

        display: flex !important;
        flex-direction: column !important;
      }

      /* iOS Safari fallback */
      .chatbot-container {
        height: -webkit-fill-available !important;
        min-height: -webkit-fill-available !important;
      }

      /* body height(calc) ë¬´ë ¥í™”: flexë¡œ ìì—° í™•ì¥ */
      .chatbot-body {
        flex: 1 1 auto !important;
        height: auto !important;
        overflow: hidden !important;
      }

      /* ëŒ€í™”ì˜ì—­ë§Œ ìŠ¤í¬ë¡¤ */
      .chatlog {
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }

      /* ì…ë ¥ì°½ í•˜ë‹¨ ì˜ë¦¼ ë°©ì§€ (safe-area) */
      .chatbot-footer {
        flex: 0 0 auto !important;
        padding-bottom: env(safe-area-inset-bottom) !important;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="fallback" class="fallback" style="display:none">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ê°€ ì—°ê²°ë˜ì–´ ìˆê³  ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ê°€ ì°¨ë‹¨ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>

  <div class="status" id="status">í”„ë¦¬ì…‹: ë‚´ì¥ ì‚¬ìš©</div>

  <button class="chatbot-toggle" id="toggleChat">ì±—ë´‡ ì—´ê¸°</button>
  <div class="chatbot-container" id="chatbot">
    <div class="chatbot-header">
      <span>ì–´ì´Œ ëŒ€í™”í˜• ì±—ë´‡</span><span id="villageTag" class="tag" style="display:none"></span>
      <span class="spacer"></span>
      <button id="btnSave" title="ì €ì¥">ğŸ’¾</button>
      <button id="btnClose" title="ë‹«ê¸°">âœ•</button>
    </div>
    <div class="chatbot-body">
      <div class="chatlog" id="chatLog" role="log" aria-live="polite"></div>
      <div class="hint">ë©”ë‰´: 1) ìˆ˜ì‚°ë¬¼ ì£¼ë¬¸  2) ë¨¹ê±°ë¦¬ ì•ˆë‚´  3) ì¹´í˜ ì¶”ì²œ  4) ì²´í—˜ ì˜ˆì•½  5) í¸ì˜ì‹œì„¤ ì•ˆë‚´  6) ì˜ˆì•½/ì£¼ë¬¸ í™•ì¸</div>
    </div>
    <div class="chatbot-footer">
      <input id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter ì „ì†¡)" />
      <button id="chatSend">ì „ì†¡</button>
    </div>
  </div>

  <!-- ìš”ì•½ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <dialog id="summaryDialog">
    <div class="modal-head">ëŒ€í™” ìš”ì•½ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="modal-body">
      <p style="font-size:13px;color:#334155">ì•„ë˜ ë‚´ìš©ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. â€œTXT ì €ì¥â€ì„ ëˆ„ë¥´ë©´ íŒŒì¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.</p>
      <textarea id="summaryText" class="mono"></textarea>
    </div>
    <div class="modal-foot">
      <button id="btnSaveTxt" class="btn-outline">TXT ì €ì¥</button>
      <button id="btnCloseSummary">ë‹«ê¸°</button>
    </div>
  </dialog>

  <!-- ì˜¤í”„ë¼ì¸ ë‚´ì¥ í”„ë¦¬ì…‹(JSON) -->
  <script type="application/json" id="preset-data">
  {
    "version": "2025-08",
    "defaults": {
      "options": {
        "species": ["ê³ ë“±ì–´","ê´‘ì–´","ê°ˆì¹˜","ì˜¤ì§•ì–´","ìƒˆìš°","ëŒ€í•˜","ë¬¸ì–´","ì „ë³µ","ì°¸ë”","ìš°ëŸ­"],
        "forms":   ["ëƒ‰ë™","ëƒ‰ì¥","í•„ë ›","ë¼ìš´ë“œ"]
      },
      "scenario": {
        "1": ["<ì–´ì¢…ì„ íƒ>","<ìƒíƒœì„ íƒ>","ëª‡ íŒ©(kg) í•„ìš”í•˜ì‹ ê°€ìš”?","ë°°ì†¡ì€ ì–´ë–»ê²Œ í•´ë“œë¦´ê¹Œìš”? ì˜ˆ: ìµì¼ íƒë°°, í˜„ì¥ ìˆ˜ë ¹","ê²°ì œëŠ” ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì˜ˆ: ì¹´ë“œ, ê³„ì¢Œì´ì²´"],
        "2": ["ì–´ë–¤ ì¢…ë¥˜ì˜ ìŒì‹ì„ ì°¾ìœ¼ì‹œë‚˜ìš”? ì˜ˆ: í•´ë¬¼íƒ•, ìƒì„ êµ¬ì´, ê°„ë‹¨í•œ ë¶„ì‹","ë“œì‹œê³  ì‹¶ì€ ë¶„ìœ„ê¸°ëŠ” ì–´ë–¤ê°€ìš”? ì˜ˆ: ê°€ì¡± ì‹ë‹¹, ë°”ë‹·ê°€ ì „ë§ ì‹ë‹¹, ì €ë… ìš´ì˜ ì‹ë‹¹"],
        "3": ["ì–´ë–¤ ë¶„ìœ„ê¸°ì˜ ì¹´í˜ë¥¼ ì›í•˜ì‹œë‚˜ìš”? ì˜ˆ: ì˜¤ì…˜ë·°, ì¡°ìš©í•œ, ë””ì €íŠ¸ ì „ë¬¸"],
        "4": ["ì–´ë–¤ ì²´í—˜ì„ ì›í•˜ì‹œë‚˜ìš”? ì˜ˆ: ë‚šì‹œ, ì¡°ê°œì¡ì´, ì–´ì´Œë¯¼ì†ì²´í—˜","ì²´í—˜ í¬ë§ ë‚ ì§œì™€ ì‹œê°„ì€ ì–¸ì œì¸ê°€ìš”? (ì˜ˆ: 2025-08-15 15:00)"],
        "5": ["ì–´ë–¤ í¸ì˜ì‹œì„¤ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ì˜ˆ: ì£¼ì°¨ì¥, í™”ì¥ì‹¤, ìƒ¤ì›Œì‹¤, ATM"],
        "6": ["ì˜ˆì•½ì ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ë’·ìë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."]
      },
      "messages": {
        "welcome": "{village}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
        "menu": "ë©”ë‰´ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”: 1) ìˆ˜ì‚°ë¬¼ ì£¼ë¬¸  2) ë¨¹ê±°ë¦¬ ì•ˆë‚´  3) ì¹´í˜ ì¶”ì²œ  4) ì²´í—˜ ì˜ˆì•½  5) í¸ì˜ì‹œì„¤ ì•ˆë‚´  6) ì˜ˆì•½/ì£¼ë¬¸ í™•ì¸",
        "ask_more": "ë” í•„ìš”í•œ ê²ƒì´ ìˆë‚˜ìš”? (ì˜ˆ/ì•„ë‹ˆì˜¤)",
        "goodbye": "ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”."
      }
    },
    "villages": {
      "FV_ULSAN": {
        "meta": {"displayName": "ìš¸ì‚°í•­ ì–´ì´Œê³„", "contact": "052-000-0000"},
        "options": { "species": ["ì˜¤ì§•ì–´","ëŒ€í•˜","ë¬¸ì–´","ê°€ìë¯¸","ì „ì–´"], "forms": ["ëƒ‰ì¥","ëƒ‰ë™","í•„ë ›","ë¼ìš´ë“œ"] },
        "scenario": { "1": ["<ì–´ì¢…ì„ íƒ> (ìš¸ì‚°ê¶Œ)","<ìƒíƒœì„ íƒ>","í•„ìš” ìˆ˜ëŸ‰(kg/íŒ©)?","ìˆ˜ë ¹: ìµì¼ íƒë°°/í˜„ì¥ (ìš¸ì‚°í•­ ìˆ˜ë ¹ ê°€ëŠ¥)","ê²°ì œ: ì¹´ë“œ/ì´ì²´/í˜„ì¥ê²°ì œ"] },
        "messages": { "welcome": "{village} ë°©ë¬¸ì„ í™˜ì˜í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ì˜ íŠ¹ì‚°: ì˜¤ì§•ì–´/ëŒ€í•˜" }
      },
      "FV_TONGYEONG": {
        "meta": {"displayName": "í†µì˜í•­ ì–´ì´Œê³„"},
        "options": { "species": ["ë©¸ì¹˜","êµ´","ë„ë‹¤ë¦¬","ì „ë³µ","ì°¸ë”"] }
      },
      "FV_GEOJE": {
        "meta": {"displayName": "ê±°ì œë„ ì–´ì´Œê³„"},
        "options": { "species": ["ê´‘ì–´","ìš°ëŸ­","ì°¸ë”","ì „ë³µ"] }
      }
    }
  }
  </script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    (function(){
      const statusEl = document.getElementById('status');

      // ===== Utility: deep merge =====
      function deepMerge(base, override){
        if (Array.isArray(base) && Array.isArray(override)) return override.slice();
        if (base && typeof base==='object' && override && typeof override==='object'){
          const out = {...base};
          for(const k of Object.keys(override)){
            out[k] = (k in base) ? deepMerge(base[k], override[k]) : override[k];
          }
          return out;
        }
        return (override!==undefined ? override : base);
      }

      // ===== Presets: load (server â†’ fallback to embedded) =====
      async function fetchWithTimeout(url, ms=3000){
        return await Promise.race([
          fetch(url, {cache:'no-store'}),
          new Promise((_,rej)=> setTimeout(()=> rej(new Error('timeout')), ms))
        ]);
      }
      function loadEmbeddedPresets(){
        try{
          const raw = document.getElementById('preset-data')?.textContent || '{}';
          return JSON.parse(raw);
        }catch(e){
          console.warn('Embedded preset JSON parse error', e);
          return {};
        }
      }
      async function loadPresetsHybrid(){
        // 1) Try server file (same directory presets.json)
        try{
          const res = await fetchWithTimeout('presets.json', 3000);
          if(res.ok){
            const data = await res.json();
            statusEl.textContent = 'í”„ë¦¬ì…‹: ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜´';
            return data;
          }
        }catch(e){
          // ignore and fallback
        }
        statusEl.textContent = 'í”„ë¦¬ì…‹: ë‚´ì¥ ì‚¬ìš©(ì˜¤í”„ë¼ì¸ ëª¨ë“œ)';
        return loadEmbeddedPresets();
      }

      // Globals
      let PRESETS = null;
      let OPTIONS = { species:[], forms:[] };
      let SCENARIO = {};
      let MSG = {};

      function applyDefaults(){
        OPTIONS = PRESETS?.defaults?.options || {species:[], forms:[]};
        SCENARIO = PRESETS?.defaults?.scenario || {};
        MSG = PRESETS?.defaults?.messages || {};
      }
      function applyVillagePreset(villageId){
        const v = PRESETS?.villages?.[villageId] || {};
        OPTIONS = deepMerge(PRESETS?.defaults?.options||{}, v.options||{});
        SCENARIO = deepMerge(PRESETS?.defaults?.scenario||{}, v.scenario||{});
        MSG = deepMerge(PRESETS?.defaults?.messages||{}, v.messages||{});
      }

      function renderQuestion(flowId, step){
        const q = SCENARIO[flowId]?.[step];
        if (!q) return '';
        if (q === '<ì–´ì¢…ì„ íƒ>' || q.startsWith('<ì–´ì¢…ì„ íƒ')){
          return "ì–´ë–¤ ìˆ˜ì‚°ë¬¼ì„ ì›í•˜ì‹œë‚˜ìš”? ë²ˆí˜¸/í…ìŠ¤íŠ¸ ì„ íƒ\n" + OPTIONS.species.map((s,i)=>`  ${i+1}. ${s}`).join("\n");
        }
        if (q === '<ìƒíƒœì„ íƒ>'){
          return "ì–´ë–¤ ìƒíƒœë¥¼ ì›í•˜ì‹œë‚˜ìš”? ë²ˆí˜¸/í…ìŠ¤íŠ¸ ì„ íƒ\n" + OPTIONS.forms.map((s,i)=>`  ${i+1}. ${s}`).join("\n");
        }
        return q;
      }
      function mapAnswer(flowId, step, txt){
        const num = parseInt(txt,10);
        const q = SCENARIO[flowId]?.[step];
        if (q && q.startsWith('<ì–´ì¢…ì„ íƒ')){
          if(!isNaN(num) && num>=1 && num<=OPTIONS.species.length) return OPTIONS.species[num-1];
          const hit = OPTIONS.species.find(s=> s.includes(txt)); return hit || txt;
        }
        if (q === '<ìƒíƒœì„ íƒ>'){
          if(!isNaN(num) && num>=1 && num<=OPTIONS.forms.length) return OPTIONS.forms[num-1];
          const hit = OPTIONS.forms.find(s=> s.includes(txt)); return hit || txt;
        }
        return txt;
      }

      // ===== Map init =====
      if (typeof L === 'undefined') {
        document.getElementById('fallback').style.display = 'flex';
        return;
      }
      const map = L.map('map').setView([35.5, 129.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      const LOCS = [
        { id: "FV_BUSAN",   name: "ë¶€ì‚° ê°ì²œí•­", lat: 35.072, lng: 129.012 },
        { id: "FV_JEJU",    name: "ì œì£¼ë„",     lat: 33.500, lng: 126.500 },
        { id: "FV_TONGYEONG", name: "í†µì˜í•­",   lat: 34.850, lng: 128.430 },
        { id: "FV_GEOJE",   name: "ê±°ì œë„",     lat: 34.880, lng: 128.630 },
        { id: "FV_ULSAN",   name: "ìš¸ì‚°í•­",     lat: 35.500, lng: 129.400 },
        { id: "FV_YEOUIDO", name: "ì„œìš¸ ì—¬ì˜ë„", lat: 37.521, lng: 126.924 }
      ];
      LOCS.forEach(loc => {
        const marker = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(`${loc.name}<br/><button data-id="${loc.id}" class="popup-open">ì±—ë´‡ ì—´ê¸°</button>`);
        marker.on('popupopen', () => {
          setTimeout(() => {
            document.querySelectorAll('.popup-open').forEach(btn => {
              btn.onclick = () => openChat(loc);
            });
          });
        });
      });

      // ===== Chatbot state =====
      const logEl = document.getElementById('chatLog');
      const input = document.getElementById('chatInput');
      window.chatHistory = []; // {role, content, ts}
      const state = {
        village: null,
        phase: 'menu',       // 'menu' | 'flow' | 'ask_more' | 'end'
        current: null,       // '1'..'6'
        step: 0,             // ì§ˆë¬¸ ì¸ë±ìŠ¤
        answers: {}          // {stepIndex: answerText}
      };
      function appendChat(role, message){
        const p = document.createElement('p');
        p.textContent = (role === 'bot' ? 'ğŸ¤– ' : 'ğŸ‘¤ ') + message;
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
        window.chatHistory.push({role, content: message, ts: Date.now()});
      }
      function fmtWelcome(villageName){
        const tpl = MSG?.welcome || '{village}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?';
        return tpl.replace('{village}', villageName);
      }
      function showMenu(){
        state.phase = 'menu';
        state.current = null; state.step = 0; state.answers = {};
        appendChat('bot', MSG?.menu || 'ë©”ë‰´ì—ì„œ ì„ íƒí•´ ì£¼ì„¸ìš”: 1) ìˆ˜ì‚°ë¬¼ ì£¼ë¬¸  2) ë¨¹ê±°ë¦¬ ì•ˆë‚´  3) ì¹´í˜ ì¶”ì²œ  4) ì²´í—˜ ì˜ˆì•½  5) í¸ì˜ì‹œì„¤ ì•ˆë‚´  6) ì˜ˆì•½/ì£¼ë¬¸ í™•ì¸');
      }
      function beginFlow(id){
        state.phase = 'flow'; state.current = id; state.step = 0; state.answers = {};
        appendChat('bot', renderQuestion(id, 0));
      }
      function handleAnswer(txt){
        const mapped = mapAnswer(state.current, state.step, txt);
        state.answers[state.step] = mapped;
        state.step++;
        const qs = SCENARIO[state.current] || [];
        if(state.step < qs.length){
          appendChat('bot', renderQuestion(state.current, state.step));
        } else {
          const title = flowTitle(state.current);
          appendChat('bot', `âœ… ${title} ìš”ì•½\n${makeFlowSummary(state.current, state.answers)}`);
          appendChat('bot', MSG?.ask_more || 'ë” í•„ìš”í•œ ê²ƒì´ ìˆë‚˜ìš”? (ì˜ˆ/ì•„ë‹ˆì˜¤)');
          state.phase = 'ask_more';
        }
      }
      function flowTitle(id){
        return {"1":"ìˆ˜ì‚°ë¬¼ ì£¼ë¬¸","2":"ë¨¹ê±°ë¦¬ ì•ˆë‚´","3":"ì¹´í˜ ì¶”ì²œ","4":"ì²´í—˜ ì˜ˆì•½","5":"í¸ì˜ì‹œì„¤ ì•ˆë‚´","6":"ì˜ˆì•½/ì£¼ë¬¸ í™•ì¸"}[id] || id;
      }
      function makeFlowSummary(id, answers){
        const qs = SCENARIO[id] || [];
        let lines = [];
        for(let i=0;i<qs.length;i++){
          const label = ['<ì–´ì¢…ì„ íƒ>','<ìƒíƒœì„ íƒ>'].includes(qs[i]) ? (qs[i]==='<ì–´ì¢…ì„ íƒ>'?'ì–´ì¢… ì„ íƒ':'ìƒíƒœ ì„ íƒ') : (qs[i].split('\n')[0]);
          lines.push(`- ${label} â†’ ${answers[i]||''}`);
        }
        return lines.join('\n');
      }

      // UI bindings
      document.getElementById('toggleChat').onclick = () => {
        const box = document.getElementById('chatbot');
        box.style.display = (box.style.display === 'flex') ? 'none' : 'flex';
        if (box.style.display === 'flex' && !state.village){
          state.village = 'GENERIC';
          document.getElementById('villageTag').textContent = state.village;
          document.getElementById('villageTag').style.display = 'inline-block';
          appendChat('bot', fmtWelcome(state.village));
          showMenu();
        }
      };
      document.getElementById('btnClose').onclick = () => document.getElementById('chatbot').style.display = 'none';
      document.getElementById('chatSend').onclick = () => onUserSend();
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); onUserSend(); } });
      function onUserSend(){
        const txt = input.value.trim(); if(!txt) return;
        appendChat('user', txt); input.value = '';
        if(state.phase === 'menu'){
          const id = txt.replace(/[^\d]/g,'');
          if(SCENARIO[id]) beginFlow(id); else appendChat('bot', '1~6 ì¤‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        if(state.phase === 'flow'){ handleAnswer(txt); return; }
        if(state.phase === 'ask_more'){
          if(/^ì˜ˆ|^yes/i.test(txt)){ showMenu(); }
          else if(/^ì•„ë‹ˆì˜¤|^no/i.test(txt)){ appendChat('bot', MSG?.goodbye || 'ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.'); state.phase='end'; }
          else appendChat('bot','ì˜ˆ/ì•„ë‹ˆì˜¤ ì¤‘ì— ì„ íƒí•´ ì£¼ì„¸ìš”.');
          return;
        }
        if(state.phase === 'end'){
          appendChat('bot','ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ë ¤ë©´ â€œì±—ë´‡ ì—´ê¸°â€ë¥¼ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
          return;
        }
      }

      function openChat(loc){
        const box = document.getElementById('chatbot');
        box.style.display = 'flex';
        state.village = loc.name;
        document.getElementById('villageTag').textContent = state.village;
        document.getElementById('villageTag').style.display = 'inline-block';
        logEl.innerHTML = '';

        // Village-specific presets
        applyVillagePreset(loc.id);

        appendChat('bot', fmtWelcome(state.village));
        showMenu();
      }

      // ===== Save (preview â†’ TXT) =====
      function buildFileName(ext){
        const d = new Date(), pad = n => String(n).padStart(2,'0');
        const ts = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        const village = (state.village || 'GENERIC').replace(/\s+/g,'_');
        return `chat_${village}_${ts}.${ext}`;
      }
      function buildSummaryText(){
        const fmt = (ts)=>{ const d = new Date(ts), p = n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; };
        return window.chatHistory.map(entry=>{
          const role = entry.role === 'bot' ? 'ğŸ¤– Bot' : 'ğŸ‘¤ User';
          return `${role} [${fmt(entry.ts)}]: ${String(entry.content).replace(/\n+/g,' ')}`;
        }).join('\n');
      }
      function downloadTxt(filename, content){
        const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
        const blob = new Blob([BOM, content], {type:'text/plain;charset=utf-8'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
      }
      function openSummaryDialog(){
        const dlg = document.getElementById('summaryDialog');
        const area = document.getElementById('summaryText');
        area.value = buildSummaryText(); dlg.showModal();
        document.getElementById('btnSaveTxt').onclick = ()=>{ if(confirm('ì´ ë‚´ìš©ìœ¼ë¡œ TXT íŒŒì¼ì„ ì €ì¥í• ê¹Œìš”?')){ downloadTxt(buildFileName('txt'), area.value); dlg.close(); } };
        document.getElementById('btnCloseSummary').onclick = ()=> dlg.close();
      }
      document.getElementById('btnSave').onclick = openSummaryDialog;
      window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); openSummaryDialog(); }});

      // ===== Boot: load presets then apply defaults =====
      (async function init(){
        PRESETS = await loadPresetsHybrid();
        applyDefaults();
      })();
    })();
  </script>
</body>
</html>
